<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tron dApp inside Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; background:#f7f9fb; }
    .wrap { max-width: 720px; margin: 0 auto; background:#fff; border:1px solid #e9eef3; border-radius:12px; padding:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button { padding: 10px 14px; background:#3375BB; color:#fff; border:none; border-radius:10px; font-weight:600; cursor:pointer; }
    button.secondary { background:#9aa3ab; }
    input { padding:10px; border:1px solid #ddd; border-radius:8px; min-width:260px; }
    .log { background:#f4f7fb; padding:12px; border-radius:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; white-space:pre-wrap; word-break:break-word; margin-top:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Tron inside Trust Wallet</h2>
    <p>Open this page inside a wallet’s DApp browser. It will request the Tron address and can sign.</p>

    <div class="row">
      <button id="connectBtn">Connect (get address)</button>
      <button id="addrBtn" class="secondary">Show Address</button>
    </div>

    <h3 style="margin-top:18px;">Sign a Message</h3>
    <div class="row">
      <input id="msg" placeholder="Message to sign" value="Hello from my dApp"/>
      <button id="signMsgBtn">Sign Message</button>
    </div>

    <h3 style="margin-top:18px;">Send TRX</h3>
    <div class="row">
      <input id="to" placeholder="Recipient TRON address (T...)" />
      <input id="amount" type="number" min="0" step="0.1" placeholder="Amount (TRX)" value="1" />
      <button id="sendBtn">Send</button>
    </div>

    <div id="log" class="log"></div>
  </div>

  <script>
    const logEl = document.getElementById("log");
    const log = (...args) => {
      console.log(...args);
      logEl.textContent += args.map(a => typeof a==="string" ? a : JSON.stringify(a,null,2)).join(" ") + "\n";
    };

    function injected() {
      return typeof window.tronWeb !== "undefined" || typeof window.tronLink !== "undefined";
    }

    async function waitForInjection(timeoutMs = 15000) {
      const t0 = Date.now();
      return new Promise(resolve => {
        const tick = () => {
          if (injected()) return resolve(true);
          if (Date.now() - t0 > timeoutMs) return resolve(false);
          setTimeout(tick, 200);
        };
        tick();
      });
    }

    async function requestAccounts() {
      if (window.tronLink?.request) {
        // Standard TronLink-compatible RPC
        return window.tronLink.request({ method: "tron_requestAccounts" });
      }
      // Some wallets auto-authorize on first access
      return;
    }

    async function currentAddress() {
      return window.tronWeb?.defaultAddress?.base58 || null;
    }

    async function connect() {
      const ok = await waitForInjection();
      if (!ok) {
        log("No Tron provider injected. Open inside a Tron wallet’s DApp browser (Trust Wallet version with Tron support, TronLink, Bitget, TokenPocket).");
        alert("No Tron provider injected. Open this page inside a Tron-capable wallet’s DApp browser.");
        return;
      }
      try {
        await requestAccounts();
      } catch (e) {
        log("requestAccounts threw (often harmless):", e.message || e);
      }
      const addr = await currentAddress();
      if (addr) {
        log("Connected address:", addr);
        alert("Connected address:\n" + addr);
      } else {
        log("Still no address. Try pressing Show Address after a moment.");
      }
    }

    async function signMessage(message) {
      // Prefer wallet RPC if available
      if (window.tronLink?.request) {
        try {
          const res = await window.tronLink.request({
            method: "tron_signMessage",
            params: { message }
          });
          log("Signed (tron_signMessage):", res);
          alert("Signed:\n" + (res?.signature || JSON.stringify(res)));
          return;
        } catch (e) {
          log("tron_signMessage failed:", e.message || e);
        }
      }
      // Fallbacks
      if (window.tronWeb?.trx?.signMessage) {
        const sig = await window.tronWeb.trx.signMessage(message);
        log("Signed (tronWeb.trx.signMessage):", sig);
        alert("Signed:\n" + JSON.stringify(sig));
        return;
      }
      if (window.tronWeb?.trx?.sign) {
        try {
          const sig = await window.tronWeb.trx.sign(message);
          log("Signed (tronWeb.trx.sign raw):", sig);
          alert("Signed:\n" + JSON.stringify(sig));
          return;
        } catch (e) {
          log("trx.sign(raw) failed:", e.message || e);
        }
      }
      alert("This wallet build doesn’t expose message signing.");
    }

    async function sendTRX(to, amountTrx) {
      const tw = window.tronWeb;
      if (!tw) throw new Error("tronWeb not injected.");
      await requestAccounts();
      const from = tw.defaultAddress?.base58;
      if (!from) throw new Error("Wallet not connected.");

      const amountSun = tw.toSun(amountTrx);
      const tx = await tw.transactionBuilder.sendTrx(to, amountSun, from);
      const signed = await tw.trx.sign(tx);
      const receipt = await tw.trx.sendRawTransaction(signed);

      log("TX:", tx);
      log("Signed:", signed?.txID || signed);
      log("Broadcast:", receipt);
      alert("Broadcasted!\nTXID: " + (receipt?.txid || signed?.txID || "unknown"));
    }

    // UI bindings
    document.getElementById("connectBtn").onclick = connect;

    document.getElementById("addrBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const addr = await currentAddress();
      if (addr) {
        log("Address:", addr);
        alert("Address:\n" + addr);
      } else {
        alert("Address not available yet. Tap Connect first.");
      }
    };

    document.getElementById("signMsgBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const msg = document.getElementById("msg").value || "Hello";
      try { await signMessage(msg); } catch (e) { log("signMessage error:", e.message || e); alert("Signing failed: " + (e.message || e)); }
    };

    document.getElementById("sendBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const to = document.getElementById("to").value.trim();
      const amount = parseFloat(document.getElementById("amount").value || "0");
      if (!to || !to.startsWith("T")) return alert("Enter a valid TRON address (starts with T).");
      if (!(amount > 0)) return alert("Enter a positive amount.");
      try { await sendTRX(to, amount); } catch (e) { log("sendTRX error:", e.message || e); alert("Send failed: " + (e.message || e)); }
    };

    // Diagnostics
    (async () => {
      log("UserAgent:", navigator.userAgent);
      const ok = await waitForInjection();
      log("Injected:", ok, "tronWeb:", typeof window.tronWeb, "tronLink:", typeof window.tronLink);
      // Some wallets require a tap to show the permission prompt the first time:
      document.body.addEventListener("touchstart", () => { /* nudge */ }, { once: true });
    })();
  </script>
</body>
</html>
