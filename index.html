<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tron dApp inside Wallet</title>
  <!-- Load TronWeb to signal a Tron dApp and help with tx building -->
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; background:#0d1117; color:#c9d1d9 }
    .wrap { max-width: 720px; margin: 0 auto; background:#161b22; border:1px solid #30363d; border-radius:12px; padding:20px }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    button { padding:10px 14px; background:#3b82f6; color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer }
    .secondary { background:#6b7280 }
    input { padding:10px; border:1px solid #30363d; border-radius:8px; min-width:260px; background:#0d1117; color:#c9d1d9 }
    .log { background:#0d1117; border:1px solid #30363d; border-radius:8px; padding:12px; margin-top:12px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:13px; white-space:pre-wrap; word-break:break-word }
  </style>
</head>
<body>
  <div class="wrap">
    <h3 style="margin-top:0">Tron inside Trust Wallet</h3>
    <p>Open this in Trust Walletâ€™s DApp browser (the Connect button in the main page will deep-link you here).</p>

    <div class="row">
      <button id="connectBtn">Connect (get address)</button>
      <button id="addrBtn" class="secondary">Show Address</button>
    </div>

    <h4 style="margin:16px 0 8px">Sign a Message</h4>
    <div class="row">
      <input id="msg" placeholder="Message to sign" value="Hello from my Tron dApp"/>
      <button id="signMsgBtn">Sign Message</button>
    </div>

    <h4 style="margin:16px 0 8px">Send TRX</h4>
    <div class="row">
      <input id="to" placeholder="Recipient TRON address (T...)" />
      <input id="amount" type="number" min="0" step="0.1" placeholder="Amount (TRX)" value="1" />
      <button id="sendBtn">Send</button>
    </div>

    <div id="log" class="log"></div>
  </div>

  <script>
    const logEl = document.getElementById("log");
    const log = (...args) => {
      console.log(...args);
      logEl.textContent += args.map(a => typeof a==="string" ? a : JSON.stringify(a,null,2)).join(" ") + "\n";
    };

    function injected() {
      return typeof window.tronWeb !== "undefined" || typeof window.tronLink !== "undefined";
    }

    async function waitForInjection(timeoutMs = 15000) {
      const t0 = Date.now();
      return new Promise(resolve => {
        const tick = () => {
          if (injected()) return resolve(true);
          if (Date.now() - t0 > timeoutMs) return resolve(false);
          setTimeout(tick, 200);
        };
        tick();
      });
    }

    async function requestAccounts() {
      if (window.tronLink?.request) {
        try {
          await window.tronLink.request({ method: "tron_requestAccounts" });
        } catch (e) {
          log("tron_requestAccounts:", e?.message || e);
        }
      }
    }

    async function currentAddress() {
      return window.tronWeb?.defaultAddress?.base58 || null;
    }

    async function connect() {
      const ok = await waitForInjection();
      if (!ok) {
        alert("No Tron provider injected. Open this page inside Trust Wallet / TronLink / Bitget / TokenPocket.");
        return;
      }
      await requestAccounts();
      const addr = await currentAddress();
      if (addr) {
        log("Connected:", addr);
        alert("Address:\n" + addr);
      } else {
        log("No address yet; try Show Address.");
      }
    }

    async function signMessage(msg) {
      try {
        if (window.tronLink?.request) {
          const res = await window.tronLink.request({
            method: "tron_signMessage",
            params: { message: msg }
          });
          log("Signed (tron_signMessage):", res);
          alert("Signed:\n" + (res?.signature || JSON.stringify(res)));
          return;
        }
        if (window.tronWeb?.trx?.signMessage) {
          const sig = await window.tronWeb.trx.signMessage(msg);
          log("Signed (tronWeb.trx.signMessage):", sig);
          alert("Signed:\n" + JSON.stringify(sig));
          return;
        }
        if (window.tronWeb?.trx?.sign) {
          const sig = await window.tronWeb.trx.sign(msg);
          log("Signed (trx.sign raw):", sig);
          alert("Signed:\n" + JSON.stringify(sig));
          return;
        }
        alert("Message signing not supported by this wallet build.");
      } catch (e) {
        log("signMessage error:", e?.message || e);
        alert("Signing failed: " + (e?.message || e));
      }
    }

    async function sendTRX(to, amountTrx) {
      try {
        const tw = window.tronWeb;
        if (!tw) throw new Error("tronWeb not injected");
        await requestAccounts();
        const from = tw.defaultAddress?.base58;
        if (!from) throw new Error("Wallet not connected");

        const amountSun = tw.toSun(amountTrx);
        const tx = await tw.transactionBuilder.sendTrx(to, amountSun, from);
        const signed = await tw.trx.sign(tx);
        const receipt = await tw.trx.sendRawTransaction(signed);

        log("TX:", tx);
        log("Signed:", signed?.txID || signed);
        log("Broadcast:", receipt);
        alert("Broadcasted!\nTXID: " + (receipt?.txid || signed?.txID || "unknown"));
      } catch (e) {
        log("sendTRX error:", e?.message || e);
        alert("Send failed: " + (e?.message || e));
      }
    }

    // Bind UI
    document.getElementById("connectBtn").onclick = connect;

    document.getElementById("addrBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const addr = await currentAddress();
      if (addr) { log("Address:", addr); alert("Address:\n" + addr); }
      else alert("Address not available yet. Tap Connect first.");
    };

    document.getElementById("signMsgBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const msg = document.getElementById("msg").value || "Hello";
      await signMessage(msg);
    };

    document.getElementById("sendBtn").onclick = async () => {
      if (!(await waitForInjection())) return alert("No Tron provider injected.");
      const to = document.getElementById("to").value.trim();
      const amount = parseFloat(document.getElementById("amount").value || "0");
      if (!to || !to.startsWith("T")) return alert("Enter a valid TRON address (starts with T).");
      if (!(amount > 0)) return alert("Enter a positive amount.");
      await sendTRX(to, amount);
    };

    // Diagnostics
    (async () => {
      log("UserAgent:", navigator.userAgent);
      const ok = await waitForInjection();
      log("Injected:", ok, "tronWeb:", typeof window.tronWeb, "tronLink:", typeof window.tronLink);
    })();
  </script>
</body>
</html>
