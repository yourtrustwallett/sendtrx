<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Connect Tron via Trust Wallet (WalletConnect v2)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; border: 1px solid #eee; border-radius: 12px; padding: 24px; }
    h2 { margin: 0 0 12px; }
    p { color: #555; }
    button { padding: 12px 18px; background: #3375BB; border: none; border-radius: 10px; color: #fff; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 12px; align-items: center; }
    #qr { margin-top: 16px; }
    .log { background: #f7f9fc; padding: 12px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; white-space: pre-wrap; word-break: break-word; margin-top: 12px; }
    .hint { font-size: 13px; color: #777; margin-top: 8px; }
  </style>
  <!-- WalletConnect v2 SignClient (UMD) -->
  <script src="https://unpkg.com/@walletconnect/sign-client@2.11.1/dist/index.umd.js"></script>
  <!-- QR code generator for desktop fallback -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>Trust Wallet + Tron (WalletConnect v2)</h2>
    <p>Tap the button on mobile. It will open Trust Wallet and ask to connect to Tron.</p>
    <div class="row">
      <button id="connectBtn">Connect Trust Wallet (Tron)</button>
      <button id="disconnectBtn" style="background:#999">Disconnect</button>
    </div>
    <div id="qr"></div>
    <div id="log" class="log"></div>
    <div class="hint">If nothing happens on mobile, ensure Trust Wallet is updated. On desktop, scan the QR in Trust Wallet: Settings → WalletConnect.</div>
  </div>

  <script>
    // ---------- Config ----------
    const PROJECT_ID = "3991601c1f72f262b3381483cf8f99e4"; // <- replace with your real projectId
    const TRON_CHAIN = "tron:728126428"; // Tron mainnet CAIP-2 chain id

    // ---------- Helpers ----------
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const logEl = document.getElementById("log");
    function log(...args) {
      console.log(...args);
      logEl.textContent += args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ") + "\n";
    }

    function deepLinkTrustWalletWithWC(uri) {
      // Trust Wallet universal link for WalletConnect v2
      // Docs: open with link.trustwallet.com/wc?uri=<encoded wc:...>
      const encoded = encodeURIComponent(uri);
      const candidates = [
        `https://link.trustwallet.com/wc?uri=${encoded}`,
        `trust://wc?uri=${encoded}`,           // older iOS scheme (fallback)
        `trustwallet://wc?uri=${encoded}`      // another fallback
      ];
      // Try first candidate in same tab for better UX
      window.location.href = candidates[0];
      // Fire secondary attempts with small delays as fallbacks
      setTimeout(() => { window.location.href = candidates[1]; }, 800);
      setTimeout(() => { window.location.href = candidates[2]; }, 1600);
    }

    function renderQR(uri) {
      const qrDiv = document.getElementById("qr");
      qrDiv.innerHTML = "";
      const canvas = document.createElement("canvas");
      qrDiv.appendChild(canvas);
      QRCode.toCanvas(canvas, uri, { width: 220 });
    }

    // Keep the active session in memory
    let signClient = null;
    let session = null;

    // ---------- Main ----------
    async function initSignClient() {
      if (signClient) return signClient;
      const ctor = window.WalletConnectSignClient?.default || window.WalletConnectSignClient;
      if (!ctor) {
        log("WalletConnect SignClient not loaded");
        throw new Error("SignClient not available");
      }
      log("Initializing SignClient...");
      signClient = await ctor.init({
        projectId: PROJECT_ID,
        metadata: {
          name: "CheckTron Demo",
          description: "Connect Tron via Trust Wallet (WalletConnect v2)",
          url: window.location.origin,
          icons: ["https://avatars.githubusercontent.com/u/37784886?s=200&v=4"]
        }
      });
      // Event listeners
      signClient.on("session_event", (event) => log("session_event:", event));
      signClient.on("session_update", ({ topic, params }) => {
        log("session_update:", params);
        const { namespaces } = params;
        if (session && namespaces) session.namespaces = namespaces;
      });
      signClient.on("session_delete", () => {
        log("session_delete");
        session = null;
      });
      return signClient;
    }

    async function connectTron() {
      try {
        document.getElementById("connectBtn").disabled = true;
        const client = await initSignClient();

        log("Creating WC connection (tron namespace)...");
        const { uri, approval } = await client.connect({
          requiredNamespaces: {
            tron: {
              chains: [TRON_CHAIN],
              methods: [
                // Supported Tron methods (varies by wallet)
                "tron_signMessage",
                "tron_signTransaction"
              ],
              events: ["accountsChanged", "chainChanged"]
            }
          }
        });

        if (uri) {
          log("WC URI generated. Mobile will deep-link Trust Wallet; desktop will show QR.");
          if (isMobile) {
            deepLinkTrustWalletWithWC(uri);
            log("Opening Trust Wallet...");
          } else {
            renderQR(uri);
            log("Scan QR in Trust Wallet: Settings → WalletConnect");
          }
        }

        // Wait for user approval in wallet
        session = await approval();
        log("Connected session:");
        log(session);

        const tronNs = session.namespaces?.tron;
        if (!tronNs) {
          log("No tron namespace approved");
          return;
        }

        // Accounts are CAIP-10: "tron:728126428:<address>"
        const accounts = tronNs.accounts || [];
        const parsed = accounts.map(a => a.split(":")[2]);
        log("Tron account(s):", parsed);

        alert("Connected Tron wallet:\n" + parsed.join("\n"));
      } catch (err) {
        console.error(err);
        log("Connect error:", err.message || err);
        alert("Connect failed: " + (err.message || err));
      } finally {
        document.getElementById("connectBtn").disabled = false;
      }
    }

    async function disconnect() {
      try {
        if (!session || !signClient) {
          log("No active session");
          return;
        }
        await signClient.disconnect({
          topic: session.topic,
          reason: { code: 6000, message: "User disconnected" }
        });
        session = null;
        log("Disconnected");
      } catch (e) {
        log("Disconnect error:", e.message || e);
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectTron);
    document.getElementById("disconnectBtn").addEventListener("click", disconnect);
  </script>
</body>
</html>
